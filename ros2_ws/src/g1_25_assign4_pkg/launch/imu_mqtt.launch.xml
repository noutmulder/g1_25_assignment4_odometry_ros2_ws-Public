<?xml version="1.0"?>
<!--
Launch file for IMU sensor package - MQTT/Wireless mode

This launch file starts:
1. MQTT Bridge Node - Receives IMU data from MQTT broker and publishes to ROS2 topics
2. Database Node - Subscribes to ROS2 topics and stores data in SQLite

Usage:
    ros2 launch imu_sensor_pkg imu_mqtt.launch.xml

With custom MQTT broker:
    ros2 launch imu_sensor_pkg imu_mqtt.launch.xml mqtt_broker:=192.168.1.100 mqtt_port:=1883
-->
<launch>
    <!-- Launch Arguments -->
    <arg name="mqtt_broker" default="localhost" description="MQTT broker hostname or IP address"/>
    <arg name="mqtt_port" default="1883" description="MQTT broker port"/>
    <arg name="mqtt_topic" default="esp32/imu/data" description="MQTT topic to subscribe to"/>
    <arg name="db_path" default="/tmp/imu_data.db" description="Path to SQLite database file"/>

    <!-- MQTT Bridge Node -->
    <node pkg="g1_25_assign4_pkg" exec="mqtt_imu_bridge" name="mqtt_imu_bridge" output="screen">
        <param name="mqtt_broker" value="$(var mqtt_broker)"/>
        <param name="mqtt_port" value="$(var mqtt_port)"/>
    <param name="mqtt_topic" value="$(var mqtt_topic)"/>
  </node>

    <!-- IMU integration to odom -->
    <node pkg="g1_25_assign4_pkg" exec="accel_velocity_approximator" name="accel_velocity_approximator" output="screen">
        <param name="odom_frame_id" value="odom"/>
        <param name="base_frame_id" value="base_link"/>
        <param name="remove_gravity_z" value="true"/>
        <param name="use_orientation_for_gravity" value="false"/>
        <param name="gravity_m_s2" value="9.81"/>
        <param name="accel_smoothing_alpha" value="0.2"/>
        <param name="accel_deadband" value="0.02"/>
        <param name="velocity_damping" value="0.02"/>
        <param name="max_dt_seconds" value="0.2"/>
    </node>

    <!-- Wheel encoder odometry (expects /wheel/encoder) -->
    <node pkg="g1_25_assign4_pkg" exec="wheel_encoder_odometry" name="wheel_encoder_odometry" output="screen">
        <param name="wheel_radius" value="0.05"/>
        <param name="track_width" value="0.20"/>
    </node>

    <!-- Database Subscriber Node -->
    <node pkg="g1_25_assign4_pkg" exec="imu_database_node" name="imu_database_node" output="screen">
        <param name="database_path" value="$(var db_path)"/>
    </node>

    <!-- Visualizer Node -->
    <node pkg="g1_25_assign4_pkg" exec="imu_vector_visualizer" name="imu_vector_visualizer" output="screen"/>

    <!-- RViz2 Node -->
    <node pkg="rviz2" exec="rviz2" name="rviz2" output="screen"
          args="-d $(find-pkg-share g1_25_assign4_pkg)/rviz/display.rviz"/>
</launch>
